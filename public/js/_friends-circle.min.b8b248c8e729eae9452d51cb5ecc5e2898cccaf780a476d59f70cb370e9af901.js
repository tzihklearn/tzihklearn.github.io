(()=>{(function(){"use strict";let e;function g(){if(!document.querySelector(".friends-circle-page"))return;if(!S()){console.error("[网友圈] 无法加载配置"),u();return}F(),k().then(()=>{if(s.length===0){u();return}b(),w(),h(e.initialDisplayCount||20),x()}).catch(e=>{console.error("[网友圈] 加载数据失败:",e),u()})}let s=[],i=0,o="all",n=[],t={},m=[],r={},c={};function F(){s=[],i=0,o="all",n=[],t={},m=[],r={},c={};const e=document.getElementById("articles-grid");e&&(e.innerHTML="");const a=document.getElementById("loading-state");a&&(a.style.display="block");const l=document.getElementById("empty-state");l&&(l.style.display="none");const d=document.getElementById("load-more-container");d&&(d.style.display="none")}function S(){const t=document.getElementById("friends-circle-config");if(!t)return!1;try{const s=t.textContent,n=JSON.parse(s);if(typeof n.linksGroups=="string")try{n.linksGroups=JSON.parse(n.linksGroups)}catch{n.linksGroups=[]}if(typeof n.groupArticleDays=="string")try{n.groupArticleDays=JSON.parse(n.groupArticleDays)}catch{n.groupArticleDays=[]}return Array.isArray(n.groupArticleDays)||(n.groupArticleDays=[]),typeof n.cardColorMode=="string"&&(n.cardColorMode=n.cardColorMode.replace(/^["']+|["']+$/g,"")),typeof n.tabColorMode=="string"&&(n.tabColorMode=n.tabColorMode.replace(/^["']+|["']+$/g,"")),typeof n.cardCustomColor=="string"&&(n.cardCustomColor=n.cardCustomColor.replace(/^["']+|["']+$/g,"")),typeof n.tabCustomColor=="string"&&(n.tabCustomColor=n.tabCustomColor.replace(/^["']+|["']+$/g,"")),n.cardColorMode||(n.cardColorMode="transparent"),n.tabColorMode||(n.tabColorMode="default"),Array.isArray(n.linksGroups)||(n.linksGroups=[]),e=n,!0}catch(e){return console.error("解析网友圈配置失败:",e),!1}}async function k(){if(s=[],e.preGeneratedJsonUrl&&e.preGeneratedJsonUrl.trim())try{let t=String(e.preGeneratedJsonUrl).trim();t=t.replace(/^["']+|["']+$/g,"");const n=await E(t);s.push(...n)}catch(e){throw console.error("从JSON加载数据失败:",e.message),e}s.length>0&&s.sort((e,t)=>{const n=new Date(e.date),s=new Date(t.date);return s-n})}async function E(e){const t=[];try{const s=await fetch(e,{method:"GET",mode:"cors",cache:"no-cache",headers:{Accept:"application/json"}});if(!s.ok)throw new Error(`JSON请求失败: ${s.status} ${s.statusText}`);const n=await s.json();let o=[];if(Array.isArray(n))o=n;else if(n.articles&&Array.isArray(n.articles))o=n.articles;else if(n.friends&&Array.isArray(n.friends))o=n.friends;else throw new Error("JSON格式不支持，期望包含 articles 数组或直接是数组");o.forEach(e=>{if(e&&(e.title||e.link)){let n=e.date;typeof n=="string"?n=C(n):n instanceof Date||(n=new Date),t.push({title:e.title||"无标题",link:e.link||e.url||"",date:n,siteName:e.siteName||e.site||e.name||"未知站点",siteUrl:e.siteUrl||e.url||"",siteAvatar:e.siteAvatar||e.avatar||"/img/avatar.png",siteGroup:e.siteGroup||e.group||"未分组",description:e.description||"",author:e.author||""})}})}catch(e){throw console.error("加载预生成JSON失败:",e),e}return t}function C(e){if(!e)return new Date;if(e instanceof Date)return e;if(typeof e=="string"){const n=e.trim().replace(/\s+/g," "),t=new Date(n);return isNaN(t.getTime())?new Date:t}return new Date}function O(t){if(!t)return e.defaultArticleDays||3;if(!e.groupArticleDays||!Array.isArray(e.groupArticleDays))return e.defaultArticleDays||3;for(const n of e.groupArticleDays)if(n&&n.name&&typeof n.days=="number"){const e=String(n.name).trim(),s=String(t).trim();if(e===s)return n.days;if(s.includes(e)||e.includes(s))return n.days}return e.defaultArticleDays||3}function b(){t={};let o=e.linksGroups||[];Array.isArray(o)||(o=[]);const a={};Array.isArray(o)&&o.forEach(e=>{e&&e.name&&e.links&&Array.isArray(e.links)&&e.links.forEach(t=>{t&&t.name&&(a[t.name]=e.name)})});const i=Array.isArray(o)?o.map(e=>e&&e.name?e.name:null).filter(e=>e!==null):[];if(!i||i.length===0){const e=new Set;s.forEach(t=>{const n=t.siteGroup||"未分组";e.add(n)}),n=Array.from(e).sort()}else n=[...i];n.forEach(e=>{t[e]=[]});const r=new Date;s.forEach(e=>{let s=e.siteGroup;!s&&e.siteName&&(s=a[e.siteName]),s||(s="未分组"),n.includes(s)||(n.includes("未分组")||(n.push("未分组"),t["未分组"]=[]),s="未分组"),t[s]||(t[s]=[]);const i=O(s),o=new Date(r);o.setDate(o.getDate()-i);const c=new Date(e.date);c>=o&&t[s].push(e)}),n.forEach(e=>{t[e]||(t[e]=[])}),Object.keys(t).forEach(e=>{t[e].length>0&&t[e].sort((e,t)=>{const n=new Date(e.date),s=new Date(t.date);return s-n})}),m=[...n]}function v(){if(o==="all"){const e=[];return Object.keys(t).forEach(n=>{t[n]&&Array.isArray(t[n])&&e.push(...t[n])}),e.sort((e,t)=>{const n=new Date(e.date),s=new Date(t.date);return s-n}),e}return t[o]||[]}function h(e){const n=document.getElementById("articles-grid"),s=document.getElementById("loading-state"),t=document.getElementById("empty-state");if(!n)return;s&&(s.style.display="none");const a=v();if(a.length===0){t&&(t.style.display="block",o==="all"?t.innerHTML="<p>暂无文章数据</p>":t.innerHTML=`
            <div style="text-align: center; padding: 2rem;">
              <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                分组"${d(o)}"暂无文章数据
              </p>
              <p style="font-size: 0.9rem; color: var(--text-tertiary); opacity: 0.8;">
                该分组下暂无文章数据
              </p>
            </div>
          `);return}t&&(t.style.display="none");const r=a.slice(i,i+e);r.forEach(e=>{const t=_(e);n.appendChild(t)}),i+=r.length,f()}function j(e){if(!e)return 1;if(r[e])return r[e];let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t=t&t;const n=Math.abs(t%8)+1;return r[e]=n,n}function y(e){if(!e)return 1;if(c[e])return c[e];let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t=t&t;const n=Math.abs(t%8)+1;return c[e]=n,n}function _(t){const n=document.createElement("a");n.className="article-card",n.href=t.link,n.target="_blank",n.rel="noopener noreferrer";const s=String(e.cardColorMode||"").replace(/^["']+|["']+$/g,"");if(s==="random"){const e=j(t.siteName);n.classList.add(`color-${e}`)}else if(s==="custom"&&e.cardCustomColor){n.classList.add("custom-color");const t=String(e.cardCustomColor||"").replace(/^["']+|["']+$/g,"");n.style.backgroundColor=t}return n.innerHTML=`
      <div class="article-card-avatar">
        <img src="${t.siteAvatar||"/img/avatar.png"}" 
             alt="${t.siteName}" 
             onerror="this.src='/img/avatar.png'">
      </div>
      <div class="article-card-info">
        <div class="article-card-site">${d(t.siteName)}</div>
        <h3 class="article-card-title">${d(t.title)}</h3>
        <div class="article-card-date">${A(t.date)}</div>
      </div>
    `,n}function w(){const s=document.getElementById("friends-circle-groups");if(!s)return;const a=n;a.forEach(n=>{if(s.querySelector(`[data-group="${n}"]`))return;const o=document.createElement("button");o.className="group-tab",o.setAttribute("data-group",n);const i=String(e.tabColorMode||"").replace(/^["']+|["']+$/g,"");if(i==="random"){const e=y(n);o.classList.add(`tab-color-${e}`)}else if(i==="custom"&&e.tabCustomColor){o.classList.add("tab-custom-color");const t=String(e.tabCustomColor||"").replace(/^["']+|["']+$/g,"");o.style.backgroundColor=t}const a=t[n]?t[n].length:0,r=a>0?`<span style="margin-left: 0.5rem; font-size: 0.75rem; opacity: 0.7;">(${a})</span>`:"";o.innerHTML=`<span>${d(n)}${r}</span>`,o.addEventListener("click",()=>p(n)),s.appendChild(o)});const i=s.querySelector('[data-group="all"]');i&&i.addEventListener("click",()=>p("all")),o==="all"&&s.classList.add("show-all-active")}function p(t){if(o===t)return;o=t;const n=document.getElementById("friends-circle-groups"),a=document.querySelectorAll(".group-tab");a.forEach(e=>{e.getAttribute("data-group")===t?e.classList.add("active"):e.classList.remove("active")}),t==="all"&&n?n.classList.add("show-all-active"):n&&n.classList.remove("show-all-active"),i=0;const s=document.getElementById("articles-grid");s&&(s.innerHTML=""),h(e.initialDisplayCount||20),window.scrollTo({top:0,behavior:"smooth"})}function x(){const t=document.getElementById("load-more-btn");if(!t)return;t.addEventListener("click",()=>{const t=e.loadMoreCount||10;h(t)}),f()}function f(){const e=document.getElementById("load-more-container"),t=document.getElementById("load-more-btn");if(!e||!t)return;const n=v();if(i>=n.length)e.style.display="none";else{e.style.display="block";const o=n.length-i,s=t.querySelector("span");s&&(s.textContent=`阅读更多 (还有 ${o} 篇)`)}}function u(){const e=document.getElementById("loading-state"),t=document.getElementById("empty-state");e&&(e.style.display="none"),t&&(t.style.display="block")}function d(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function A(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";const n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${s}-${o}`}window.initFriendsCircle=g;let l=0;const M=100;function a(){if(!document.querySelector(".friends-circle-page"))return;const e=document.getElementById("friends-circle-config"),t=e?e.textContent:null;let n=!1;if(t&&t.trim())try{const e=JSON.parse(t);e&&typeof e=="object"&&(n=!0)}catch{n=!1}e&&n?(l=0,g()):(l++,l<M?setTimeout(a,50):(console.error("网友圈初始化失败：配置元素未找到或超时"),e?console.error("配置元素存在但内容无效:",t):console.error("配置元素不存在"),u()))}function T(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(a,0)}):window.requestAnimationFrame?requestAnimationFrame(()=>{setTimeout(a,0)}):setTimeout(a,0),document.readyState!=="complete"&&window.addEventListener("load",()=>{setTimeout(a,100)})}T(),document.addEventListener("pjax:complete",function(){l=0,setTimeout(()=>{a()},100)})})()})()